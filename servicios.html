<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Servicios</title>

  <link rel="stylesheet" href="./styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ===== Cover y velo (mismo look de agenda) ===== */
    .page-cover{
      position: fixed; inset: 0;
      background-size: cover; background-position: center;
      filter: saturate(.96) contrast(.98) brightness(.98);
      z-index: 0;
    }
    .phone::before{
      content:""; position: fixed; inset: 0; z-index: 0;
      background: color-mix(in oklab, var(--bg) 82%, transparent);
      backdrop-filter: blur(2px);
    }

    /* ===== Banner reutilizable (igual a agenda) ===== */
    .banner{
      position: relative;
      margin: 12px 12px 8px;
      padding: 14px 16px;
      border-radius: 16px;
      background: var(--bg);
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
      overflow: visible !important; /* FIX para que el men√∫ no se corte */
    }
    .banner.banner--with-cover::before{
      content: ""; position: absolute; inset: 0;
      background-image: var(--cover-url);
      background-size: cover; background-position: center;
      filter: blur(2px); opacity: .28; pointer-events: none;
    }
    .banner.banner--with-cover::after{
      content: ""; position: absolute; inset: 0;
      background: linear-gradient(to bottom, rgba(var(--brand-rgb)/.10), rgba(255 255 255/.15));
      pointer-events: none;
    }
    .banner__row{
      position: relative; z-index: 1;
      display: grid; grid-template-columns: auto 1fr auto;
      gap: 10px; align-items: center;
    }
    .avatar{
      width: 40px; height: 40px; border-radius: 999px;
      object-fit: cover; object-position: center;
      border: 2px solid rgba(255,255,255,.7);
      box-shadow: 0 2px 8px rgba(0,0,0,.10);
    }
    .banner__name{ font-weight: 600; color:#1a1a1a; }

    /* Bot√≥n 3 puntos y panel (mismo de agenda) */
    .menu-btn{
      font-size: 22px; line-height: 1;
      width: 40px; height: 40px; border-radius: 999px;
      border: 0; cursor: pointer; display: grid; place-items: center;
      backdrop-filter: blur(6px);
      background: rgba(var(--brand-rgb, 96 96 96) / .15);
      color: #111;
      box-shadow: 0 2px 10px rgba(0,0,0,.10), inset 0 0 0 1px rgba(255,255,255,.4);
      position: relative; z-index: 2;
    }
    .menu-btn:hover{ background: rgba(var(--brand-rgb, 96 96 96) / .25); }
    .menu-panel{
      position: absolute; right: 12px; top: 56px;
      min-width: 220px; border-radius: 16px; padding: 8px;
      background: rgba(255,255,255,.95); backdrop-filter: blur(10px);
      box-shadow: 0 12px 28px rgba(0,0,0,.18);
      border: 1px solid rgba(0,0,0,.06); z-index: 1000;
    }
    .menu-panel[hidden]{
      display: block !important;
      visibility: hidden; opacity: 0; transform: translateY(-8px);
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease, visibility .2s;
    }
    .menu-panel:not([hidden]){ visibility: visible; opacity: 1; transform: none; }
    .menu-panel a,
    .menu-panel button{
      all: unset; display:block; width:100%;
      padding:10px 12px; border-radius:10px; font-size:14px; color:#1f2937; cursor:pointer;
    }
    .menu-panel a:hover,
    .menu-panel button:hover{ background: rgba(var(--brand-rgb, 96 96 96) / .10); }
    .menu-panel .menu-logout{ color:#b91c1c; font-weight:600; border-top:1px solid rgba(0,0,0,.06); margin-top:4px; padding-top:10px; }

    /* ===== Estilos espec√≠ficos de esta pantalla ===== */
    .svc-wrap{
      position: relative; z-index: 1;
      margin: 12px auto 80px; padding: 14px 16px;
      border-radius: 16px;
      background: rgba(var(--brand-rgb, 221 51 139) / .10);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(var(--brand-rgb, 221 51 139) / .18);
      box-shadow: 0 8px 22px rgba(0,0,0,.06); max-width: 760px;
    }
    .svc-row{ display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .svc-row--3{ grid-template-columns: 2fr 1fr 1fr; }
    .svc-actions{ display:flex; gap:10px; justify-content:flex-end; }
    .svc-btn{
      height: 42px; padding: 0 16px; border-radius: 999px; font-weight: 600;
      border: 1px solid rgba(var(--brand-rgb)/.45); color: var(--brand); background: #fff;
      cursor: pointer;
    }
    .svc-btn--primary{
      color:#fff; background: var(--brand);
      border-color: color-mix(in oklab, var(--brand) 70%, #000);
    }
    .svc-list{ margin-top: 16px; display: grid; gap: 10px; }
    .svc-item{
      display: grid; grid-template-columns: 1fr 120px 110px auto; gap: 10px; align-items: center;
      background: #fff; border: 1px solid rgba(0,0,0,.06); border-radius: 12px; padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .svc-name{ font-weight: 700; }
    .svc-price{ color: #1f2937; font-weight: 600; }
    .svc-min{ color: #555; font-weight: 600; }
    .svc-item .small-btn{
      border-radius: 10px; padding: 8px 10px; border: 1px solid rgba(0,0,0,.08); cursor: pointer;
      background: rgba(var(--brand-rgb) / .10); color: #1f2937; font-weight: 600;
    }
    .svc-item .small-btn:hover{ background: rgba(var(--brand-rgb)/.18); }
    .svc-item .danger{ background: rgba(185 28 28 / .10); border-color: rgba(185 28 28 / .25); color: #b91c1c; }
    .svc-item .danger:hover{ background: rgba(185 28 28 / .16); }
    .svc-note{ font-size: 12px; color: #666; margin-top: 6px; }
    .input--rect{ border-radius: 10px; }
    .right{ text-align: right; }

/* =============================================== */
/* ===== REGLAS PARA PANTALLAS PEQUE√ëAS (M√ìVIL) ===== */
/* =============================================== */

/* Esto se aplica solo si la pantalla mide 767px o menos */
@media (max-width: 767px) {

  /* 1. Arregla el formulario para A√ëADIR servicios */
  .svc-row--3 {
    /* En lugar de 3 columnas, haz que cada elemento ocupe su propia fila */
    grid-template-columns: 1fr;
  }

  /* Alinea los botones del formulario a la izquierda en m√≥vil */
  .svc-row--3 .svc-actions {
    justify-content: flex-start;
  }

  /* 2. Arregla la LISTA de servicios (el problema principal) */
  .svc-item {
    /* Cambiamos la cuadr√≠cula de 4 columnas a una m√°s flexible de 2x3 */
    grid-template-columns: 1fr 1fr; /* Dos columnas de igual tama√±o */
    grid-template-areas:
      "name    name"
      "price   min"
      "actions actions";
    row-gap: 8px; /* Un poco de espacio vertical entre las filas */
    padding: 14px;
    text-align: left; /* Alineamos todo a la izquierda para consistencia */
  }

  /* Ahora asignamos cada pieza a su √°rea en la nueva cuadr√≠cula */
  .svc-item .svc-name {
    grid-area: name;
    font-size: 16px; /* Hacemos el nombre un poco m√°s grande */
  }

  .svc-item .svc-price {
    grid-area: price;
  }

  .svc-item .svc-min {
    grid-area: min;
  }

  /* El contenedor de los botones es el √∫ltimo hijo directo del item */
  .svc-item > div:last-child {
    grid-area: actions;
    justify-content: flex-start; /* Alineamos los botones a la izquierda */
    margin-top: 8px;
  }
}




  </style>
</head>
<body>
  <main class="phone">


    <!-- ===== PEGA ESTE C√ìDIGO AQU√ç ===== -->
    <div id="loader" class="loader-container">
      <div class="loader-spinner"></div>
      <p>Cargando...</p>
    </div>
    <!-- ================================ -->

    <div class="page-cover" id="pageCover" aria-hidden="true"></div>

    <img src="./assets/hojas.svg" alt="" aria-hidden="true" class="leaf leaf--tl">

    
    <!-- Fondo -->
    <div class="page-cover" id="pageCover" aria-hidden="true"></div>

    <!-- Hojas decorativas -->
    <img src="./assets/hojas.svg" alt="" aria-hidden="true" class="leaf leaf--tl">
    <img src="./assets/hojas.svg" alt="" aria-hidden="true" class="leaf leaf--br">

    <!-- Banner principal con men√∫ -->
    <header class="banner" id="banner">
      <div class="banner__row">
        <img id="bizLogo" class="avatar" src="./assets/logo.svg" alt="Logo" />
        <div class="banner__name" id="bizName">Mi negocio</div>

        <button id="menuBtn" class="menu-btn" aria-label="Men√∫" aria-haspopup="menu" aria-expanded="false">‚ãÆ</button>
        <nav id="menuPanel" class="menu-panel" hidden role="menu" aria-labelledby="menuBtn">
          <a role="menuitem" href="./agenda.html">Inicio</a>
          <a role="menuitem" href="./realizadas.html">Citas realizadas</a>
          <a role="menuitem" href="./canceladas.html">Citas canceladas</a>
          <a role="menuitem" href="./servicios.html">Servicios</a>
          <a role="menuitem" href="./horarios.html">Horarios y bloqueos</a>
          <a role="menuitem" href="./configuracion.html">Configuraci√≥n</a>
          
          <button role="menuitem" type="button" class="menu-logout" data-action="logout">Cerrar sesi√≥n</button>
        </nav>
      </div>
    </header>

    <!-- EL ENCABEZADO DUPLICADO HA SIDO ELIMINADO -->

    <!-- Formulario para a√±adir/editar servicios -->
    <section class="svc-wrap">
      <div class="field">
        <label class="label">Nombre del servicio</label>
        <input id="svcName" class="input input--rect" type="text" placeholder="Ej. Manicure" />
      </div>

      <div class="svc-row svc-row--3" style="margin-top:10px">
        <div class="field">
          <label class="label">Precio</label>
          <input id="svcPrice" class="input input--rect right" type="text" inputmode="numeric" placeholder="0" />
        </div>
        <div class="field">
          <label class="label">Duraci√≥n (min)</label>
          <input id="svcMin" class="input input--rect right" type="number" min="1" step="1" placeholder="60" />
        </div>
        <div class="field" style="align-self:end;">
          <div class="svc-actions">
            <button id="btnCancel" class="svc-btn" type="button" hidden>Cancelar</button>
            <button id="btnSave" class="svc-btn svc-btn--primary" type="button">A√±adir servicio</button>
          </div>
        </div>
      </div>

      <div class="svc-note">Puedes a√±adir varios servicios. Toca ‚úèÔ∏è para editar o üóëÔ∏è para borrar.</div>

      <!-- Lista de servicios existentes -->
      <div id="svcList" class="svc-list" style="margin-top:14px"></div>
    </section>

    <!-- Toast para notificaciones -->
    <div id="toast" class="toast" hidden role="alert" aria-live="assertive"></div>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./supabaseClient.js"></script>

  <script>
  (async () => {
    /* ===== Funciones de Ayuda (Helpers) ===== */
    function showToast(msg, type='info', ms=2200){
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.className = `toast toast--${type} is-visible`;
      t.hidden = false;
      clearTimeout(window._toastTimer);
      window._toastTimer = setTimeout(()=>{ t.classList.remove('is-visible'); t.hidden = true; }, ms);
    }
    function hexToRgb(hex){
      const n = hex.replace('#','');
      const big = parseInt(n.length===3 ? n.split('').map(c=>c+c).join('') : n.slice(0,6), 16);
      return { r:(big>>16)&255, g:(big>>8)&255, b:big&255 };
    }
    const groupThousands = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    /* ===== Sesi√≥n y Autenticaci√≥n ===== */
    const { data: u } = await sb.auth.getUser();
    if (!u?.user) { location.href = 'login.html'; return; }
    const userId = u.user.id;

    /* ===== Carga de datos del negocio para tema y portada ===== */
    const { data: biz, error: bizErr } = await sb
      .from('businesses')
      .select('*')
      .eq('user_id', userId)
      .order('updated_at', { ascending: false })
      .limit(1)
      .maybeSingle();

    if (bizErr) { console.error(bizErr); showToast('Error cargando negocio','error'); return; }
    if (!biz) { location.href = 'personalizacion.html'; return; }

    // Aplicar tema (colores, etc.)
    const root = document.documentElement;
    const brand = (biz.brand || '#DD338B').toUpperCase();
    root.style.setProperty('--brand', brand);
    const {r,g,b} = hexToRgb(brand);
    root.style.setProperty('--brand-rgb', `${r} ${g} ${b}`);
    root.style.setProperty('--bg', biz.bg_pastel || '#FAE9F2');

    // Configurar Header y fondo
    document.getElementById('bizName').textContent = biz.business_name || 'Mi negocio';
    const logoEl = document.getElementById('bizLogo');
    const defaultLogo = './assets/logo.svg';
    logoEl.src = biz.logo_url || defaultLogo;
    logoEl.onerror = () => { logoEl.src = defaultLogo; };

    const pageCover = document.getElementById('pageCover');
    const banner    = document.getElementById('banner');
    if (biz.cover_url) {
      pageCover.style.backgroundImage = `url('${biz.cover_url}')`;
      banner.style.setProperty('--cover-url', `url('${biz.cover_url}')`);
      banner.classList.add('banner--with-cover');
    }

    /* ===== Men√∫ Desplegable (3 puntos) ===== */
    const menuBtn   = document.getElementById('menuBtn');
    const menuPanel = document.getElementById('menuPanel');
    function closeMenu() {
      if (menuPanel.hidden) return;
      menuPanel.hidden = true;
      menuBtn.setAttribute('aria-expanded', 'false');
    }
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const open = menuPanel.hidden;
      menuPanel.hidden = !open;
      menuBtn.setAttribute('aria-expanded', String(open));
    });
    document.addEventListener('click', (e) => {
      if (!menuPanel.hidden && !menuPanel.contains(e.target) && e.target !== menuBtn) closeMenu();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
    menuPanel.addEventListener('click', async (e) => {
      if (e.target?.dataset?.action === 'logout') {
        try { await sb.auth.signOut(); location.href = 'login.html'; }
        catch(err){ console.error(err); }
      }
    });

    /* ===== L√≥gica CRUD para Servicios ===== */
    const listEl   = document.getElementById('svcList');
    const nameEl   = document.getElementById('svcName');
    const priceEl  = document.getElementById('svcPrice');
    const minEl    = document.getElementById('svcMin');
    const btnSave  = document.getElementById('btnSave');
    const btnCancel= document.getElementById('btnCancel');
    let editingId = null;

    // Formateo de miles en el campo de Precio
    function formatPriceInput() {
      const digits = priceEl.value.replace(/\D/g, '');
      if (!digits) { priceEl.value = ''; return; }
      priceEl.value = groupThousands(digits);
    }
    priceEl.addEventListener('input', formatPriceInput);
    priceEl.addEventListener('blur', formatPriceInput);

    async function loadServices(){
      const { data, error } = await sb
        .from('services')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: true });

      if (error) { console.error(error); showToast('No se pudieron cargar los servicios', 'error'); return; }
      renderList(data || []);
    }

    function renderList(items){
      listEl.innerHTML = '';
      if (!items.length){
        const empty = document.createElement('div');
        empty.className = 'card empty';
        empty.textContent = 'A√∫n no tienes servicios. A√±ade el primero arriba.';
        listEl.appendChild(empty);
        return;
      }
      for (const it of items){
        const row = document.createElement('div');
        row.className = 'svc-item';
        const name = document.createElement('div');
        name.className = 'svc-name';
        name.textContent = it.name;
        const price = document.createElement('div');
        price.className = 'svc-price';
        price.textContent = `$ ${groupThousands(Math.round(Number(it.price)||0))}`;
        const dur = document.createElement('div');
        dur.className = 'svc-min';
        dur.textContent = `${it.duration_min} min`;
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';
        actions.style.justifyContent = 'flex-end';
        const editBtn = document.createElement('button');
        editBtn.className = 'small-btn';
        editBtn.textContent = '‚úèÔ∏è Editar';
        editBtn.onclick = () => startEdit(it);
        const delBtn = document.createElement('button');
        delBtn.className = 'small-btn danger';
        delBtn.textContent = 'üóëÔ∏è Borrar';
        delBtn.onclick = () => removeService(it.id);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        row.appendChild(name);
        row.appendChild(price);
        row.appendChild(dur);
        row.appendChild(actions);
        listEl.appendChild(row);
      }
    }

    function startEdit(it){
      editingId = it.id;
      nameEl.value = it.name;
      priceEl.value = groupThousands(Math.round(Number(it.price)||0));
      minEl.value = it.duration_min;
      btnSave.textContent = 'Guardar cambios';
      btnCancel.hidden = false;
      nameEl.focus();
    }

    function resetForm(){
      editingId = null;
      nameEl.value = '';
      priceEl.value = '';
      minEl.value = '';
      btnSave.textContent = 'A√±adir servicio';
      btnCancel.hidden = true;
    }
    btnCancel.onclick = resetForm;

    btnSave.onclick = async () => {
      const name = nameEl.value.trim();
      const raw = priceEl.value.replace(/\./g,'').replace(/\D/g,'');
      const price = raw ? Number(raw) : 0;
      const mins  = parseInt(minEl.value || '0', 10);

      if (!name){ showToast('Escribe el nombre del servicio','error'); nameEl.focus(); return; }
      if (!mins || mins < 1){ showToast('Duraci√≥n inv√°lida','error'); minEl.focus(); return; }

      const payload = {
        user_id: userId,
        name,
        price,
        duration_min: mins,
      };

      if (editingId){
        const { error } = await sb.from('services').update(payload).eq('id', editingId);
        if (error){ console.error(error); showToast('No se pudo actualizar','error'); return; }
        showToast('Servicio actualizado','success');
      } else {
        const { error } = await sb.from('services').insert(payload);
        if (error){ console.error(error); showToast('No se pudo guardar','error'); return; }
        showToast('Servicio a√±adido','success');
      }
      resetForm();
      loadServices();
    };

    async function removeService(id){
      if (!confirm('¬øEliminar este servicio?')) return;
      const { error } = await sb.from('services').delete().eq('id', id);
      if (error){ console.error(error); showToast('No se pudo eliminar','error'); return; }
      showToast('Servicio eliminado','success');
      loadServices();
    }

    // Carga inicial de los servicios
    await loadServices();
    document.getElementById('loader').classList.add('hidden');
  })();
  </script>
</body>
</html>