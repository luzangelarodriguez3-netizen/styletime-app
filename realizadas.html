<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Citas realizadas</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <main class="phone">

    <!-- ===== PEGA ESTE C√ìDIGO AQU√ç ===== -->
    <div id="loader" class="loader-container">
      <div class="loader-spinner"></div>
      <p>Cargando...</p>
    </div>
    <!-- ================================ -->

    <div class="page-cover" id="pageCover" aria-hidden="true"></div>

    <img src="./assets/hojas.svg" alt="" aria-hidden="true" class="leaf leaf--tl">


    <!-- Cover/fondo como en agenda -->
    <div class="page-cover" id="pageCover" aria-hidden="true"></div>

    <!-- Hojas decorativas (mismo markup que agenda) -->
    <img src="./assets/hojas.svg" alt="" aria-hidden="true" class="leaf leaf--tl">
    <img src="./assets.svg" alt="" aria-hidden="true" class="leaf leaf--br">
    <div class="bg-deco bg-deco--tl" aria-hidden="true"></div>
    <div class="bg-deco bg-deco--br" aria-hidden="true"></div>

    <!-- Encabezado id√©ntico al de agenda -->
    <header class="banner" id="banner">
      <div class="banner__row">
        <img id="bizLogo" class="avatar" src="./assets/logo.svg" alt="Logo" />
        <div class="banner__name" id="bizName">Mi negocio</div>

        <button id="menuBtn" class="icon-btn menu-btn" aria-label="Men√∫" aria-haspopup="menu" aria-expanded="false">‚ãÆ</button>
        <nav id="menuPanel" class="menu-panel" hidden role="menu" aria-labelledby="menuBtn">
          <a role="menuitem" href="./agenda.html">Inicio</a>
          <a role="menuitem" href="./realizadas.html">Citas realizadas</a>
          <a role="menuitem" href="./canceladas.html">Citas canceladas</a>
          <a role="menuitem" href="./servicios.html">Servicios</a>
          <a role="menuitem" href="./horarios.html">Horarios y bloqueos</a>
          <a role="menuitem" href="./configuracion.html">Configuraci√≥n</a>
          
          <button role="menuitem" type="button" class="menu-logout" data-action="logout">Cerrar sesi√≥n</button>
        </nav>
      </div>
    </header>

    <!-- T√≠tulo de p√°gina -->
    <section class="agenda-header" style="padding: 0 16px;">
      <h1 class="screen-title" style="margin:8px 0 0; font-weight:700;">
        üóÇÔ∏è Citas realizadas
      </h1>
    </section>

    <!-- Calendario (SIN estilos de pasado/futuro; todo blanco) -->
    <section class="glass calendar">
      <div class="calendar__top">
        <button class="cal-nav" id="prevMonth" aria-label="Mes anterior">‚Äπ</button>
        <div class="calendar__title">
          <span id="monthName">OCT</span>
          <span id="yearNum">2025</span>
        </div>
        <button class="cal-nav" id="nextMonth" aria-label="Mes siguiente">‚Ä∫</button>
      </div>

      <div class="calendar__grid">
        <div class="dow">
          <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
        </div>
        <div id="daysGrid"></div>
      </div>
    </section>

    <!-- Listado -->
    <section class="appointments">
      <h2 class="appointments__title" id="dayTitle">Citas realizadas del d√≠a</h2>
      <div id="apptList" class="appointments__list"></div>
    </section>

    <div id="toast" class="toast" hidden role="alert" aria-live="assertive"></div>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./supabaseClient.js"></script>

  <script>
  (async () => {
    // ===== Sesi√≥n =====
    const { data: u } = await sb.auth.getUser();
    if (!u?.user) { location.href = 'login.html'; return; }
    const userId = u.user.id;

    // ===== Helpers =====
    const daysGrid = document.getElementById('daysGrid');
    const apptList = document.getElementById('apptList');
    const dayTitle = document.getElementById('dayTitle');

    function hexToRgb(hex){
      const n = hex.replace('#','');
      const big = parseInt(n.length===3 ? n.split('').map(c=>c+c).join('') : n.slice(0,6), 16);
      return { r:(big>>16)&255, g:(big>>8)&255, b:big&255 };
    }
    function showToast(msg, type='info', ms=2200){
      const t=document.getElementById('toast'); if(!t) return;
      t.textContent=msg;
      t.className=`toast toast--${type} is-visible`;
      t.hidden=false;
      clearTimeout(window._toastTimer);
      window._toastTimer=setTimeout(()=>{ t.classList.remove('is-visible'); t.hidden=true; }, ms);
    }
    const fmtMoney = n => Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
    const addMinutes = (hhmm, mins) => {
      const [h,m] = (hhmm||'00:00').split(':').map(Number);
      const d = new Date(0,0,0,h||0,m||0,0);
      d.setMinutes(d.getMinutes() + (mins||0));
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    };
    const to12h = hhmm => {
      const [h,m] = (hhmm||'00:00').split(':').map(Number);
      return new Date(0,0,0,h||0,m||0).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true}).toUpperCase();
    };

    // ===== Tema / negocio (igual que agenda) =====
    const { data: biz, error: bizErr } = await sb
      .from('businesses')
      .select('*')
      .eq('user_id', userId)
      .order('updated_at', { ascending: false })
      .limit(1)
      .maybeSingle();
    if (bizErr) { console.error(bizErr); return; }
    if (!biz) { location.href = 'personalizacion.html'; return; }

    const nameEl = document.getElementById('bizName');
    nameEl.textContent = biz.business_name || 'Mi negocio';
    document.title = `${nameEl.textContent} ¬∑ Citas realizadas`;

    const root = document.documentElement;
    const brand = (biz.brand || '#DD338B').toUpperCase();
    const { r,g,b } = hexToRgb(brand);
    root.style.setProperty('--brand', brand);
    root.style.setProperty('--brand-rgb', `${r} ${g} ${b}`);
    root.style.setProperty('--bg', biz.bg_pastel || '#FAE9F2');

    const logoEl = document.getElementById('bizLogo');
    logoEl.src = biz.logo_url || './assets/logo.svg';
    logoEl.onerror = () => { logoEl.src = './assets/logo.svg'; };

    const banner = document.getElementById('banner');
    const pageCover = document.getElementById('pageCover');
    if (biz.cover_url){
      pageCover.style.backgroundImage = `url('${biz.cover_url}')`;
      banner.style.setProperty('--cover-url', `url('${biz.cover_url}')`);
      banner.classList.add('banner--with-cover');
    }

    // ===== Men√∫ (3 punticos) =====
    const menuBtn = document.getElementById('menuBtn');
    const menuPanel = document.getElementById('menuPanel');
    function closeMenu(){ if(menuPanel.hidden) return; menuPanel.hidden = true; menuBtn.setAttribute('aria-expanded','false'); }
    menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const open = menuPanel.hidden; menuPanel.hidden = !open; menuBtn.setAttribute('aria-expanded', String(open)); });
    document.addEventListener('click', (e)=>{ if(!menuPanel.hidden && !menuPanel.contains(e.target) && e.target !== menuBtn){ closeMenu(); }});
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeMenu(); });
    menuPanel.addEventListener('click', async (e)=>{ if(e.target?.dataset?.action === 'logout'){ try{ await sb.auth.signOut(); location.href='login.html'; } catch(err){ console.error(err); }}});


    document.getElementById('loader').classList.add('hidden');

    // ===== Calendario (todas las fechas blancas; solo .is-selected usa brand) =====
    const monthName = document.getElementById('monthName');
    const yearNum = document.getElementById('yearNum');
    const MONTHS = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];

    const todayObj = new Date();
    const todayStr = `${todayObj.getFullYear()}-${String(todayObj.getMonth()+1).padStart(2,'0')}-${String(todayObj.getDate()).padStart(2,'0')}`;

    let current = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);

    function renderMonth(d){
      monthName.textContent = MONTHS[d.getMonth()];
      yearNum.textContent   = d.getFullYear();
      daysGrid.innerHTML = '';

      const firstDow = (new Date(d.getFullYear(), d.getMonth(), 1).getDay() + 6) % 7;
      const lastDate = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();

      // celdas vac√≠as al inicio
      for (let i=0;i<firstDow;i++){
        const e = document.createElement('div');
        e.className = 'day is-empty';
        daysGrid.appendChild(e);
      }
      // d√≠as (todos blancos)
      for (let day=1; day<=lastDate; day++){
        const e = document.createElement('div');
        e.className = 'day';
        e.textContent = day;
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dayStr = `${y}-${m}-${String(day).padStart(2,'0')}`;
        e.dataset.date = dayStr;
        daysGrid.appendChild(e);
      }
    }

    // ===== Cargar citas realizadas de un d√≠a =====
    async function loadDoneAppointments(dayISO){
      apptList.innerHTML = '<div class="card empty">Cargando citas...</div>';

      const { data, error } = await sb
        .from('appointments')
        .select('customer_name, service_name, price, time, duration_minutes')
        .eq('user_id', userId)
        .eq('date', dayISO)
        .eq('status','done')
        .order('time', { ascending: true });

      apptList.innerHTML = '';
      if (error){
        console.error(error);
        apptList.innerHTML = '<div class="card empty">Error al cargar las citas.</div>';
        return;
      }
      if (!data || !data.length){
        apptList.innerHTML = '<div class="card empty">No hay citas realizadas para este d√≠a.</div>';
        return;
      }

      for (const a of data){
        const start = a.time;
        const end   = addMinutes(start, a.duration_minutes || 0);
        const timeRange = `${to12h(start)}‚Äì${to12h(end)}`;

        const card = document.createElement('div');
        card.className = 'card appt'; // reutiliza los estilos existentes

        const left = document.createElement('div');
        left.innerHTML = `
          <div class="appt__name">${a.customer_name || ''}</div>
          <div class="appt__meta">
            <span>${a.service_name || ''}</span>
            <span class="appt__price">${fmtMoney(a.price)}</span>
          </div>
        `;

        const right = document.createElement('div');
        right.className = 'appt__time';
        right.textContent = timeRange;

        card.appendChild(left);
        card.appendChild(right);
        apptList.appendChild(card);
      }
    }

    // Nav mes
    document.getElementById('prevMonth').onclick = async () => {
      current = new Date(current.getFullYear(), current.getMonth()-1, 1);
      renderMonth(current);
    };
    document.getElementById('nextMonth').onclick = async () => {
      current = new Date(current.getFullYear(), current.getMonth()+1, 1);
      renderMonth(current);
    };

    // Click d√≠a (marca seleccionado en color de marca y carga realizadas)
    daysGrid.addEventListener('click', async (e)=>{
      const box = e.target.closest('.day');
      if (!box || box.classList.contains('is-empty')) return;

      daysGrid.querySelectorAll('.day.is-selected').forEach(d=>d.classList.remove('is-selected'));
      box.classList.add('is-selected');

      const dateStr = box.dataset.date;
      const d = new Date(`${dateStr}T00:00:00`);
      const fmt = d.toLocaleDateString('es-ES', { day:'numeric', month:'long', year:'numeric' });
      dayTitle.textContent = `Citas realizadas del ${fmt}`;

      await loadDoneAppointments(dateStr);
    });

    // PEGA ESTE NUEVO BLOQUE EN SU LUGAR:

// ===== Carga inicial (Versi√≥n Progresiva) =====
// 1. Dibuja la estructura del calendario INMEDIATAMENTE.
renderMonth(current);

// 2. Selecciona el d√≠a de hoy en el calendario.
const todayEl = daysGrid.querySelector(`[data-date="${todayStr}"]`);
if (todayEl){
  todayEl.classList.add('is-selected');
  dayTitle.textContent = `Citas realizadas de hoy (${todayObj.toLocaleDateString('es-ES', {day:'numeric', month:'long'})})`;
}

// 3. Ahora, pide los datos "pesados" (citas realizadas del d√≠a)
//    y deja que se carguen en segundo plano sin bloquear la p√°gina.
loadDoneAppointments(todayStr);
  })();
  </script>
</body>
</html>