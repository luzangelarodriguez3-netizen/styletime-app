<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi agenda</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Ajustes puntuales locales -->
  <style>
    /* 1) Permitir clic en d√≠as pasados (siguen grises, pero clickeables) */
    .day.is-past{
      cursor: pointer;
      pointer-events: auto; /* override de estilos anteriores */
    }

    /* 2) Tarjeta vencida (ya pas√≥ la hora fin) con texto legible */
    .appt.appt--expired{
      background:#e5e7eb !important;   /* gris claro */
      color:#111 !important;            /* texto negro */
      opacity: .98;
    }
    .appt.appt--expired *{
      color:#111 !important;
    }
    .appt.appt--expired .appt__time{
      background:#fff !important;
      border: 1px solid #cbd5e1 !important;
    }

    /* 3) Botones de estado en el modal */
    .btn-status{
      display:inline-block;
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(var(--brand-rgb, 221 51 139) / .18);
      background:#f3f4f6;    /* gris claro base */
      color:#111;
      font-weight:700;
    }
    .btn-status + .btn-status{ margin-left: 12px; }

    /* estado activo por tipo */
    .btn-confirmed.is-active{ background:#fde68a; border-color:#f59e0b; }  /* amarillo */
    .btn-done.is-active{ background:#86efac; border-color:#22c55e; }       /* verde */
    .btn-cancelled.is-active{ background:#ef4444; border-color:#b91c1c; color:#fff; } /* rojo */

    /* chips/inputs del modal */
    .appt-chip{
      display:inline-block; padding: 8px 12px; border-radius:10px;
      background:#fff; border:1px solid rgba(0,0,0,.08); font-weight:700;
    }
    .appt-field{
      margin-top:8px; padding:10px 12px; border-radius:10px;
      background:rgba(255,255,255,.65); border:1px solid rgba(0,0,0,.06);
      font-size:13px; color:#444;
    }

    /* Backdrop y contenedor del di√°logo (ya ten√≠as estilos globales; por si acaso) */
    .appt-backdrop{
      position: fixed; inset:0; background: rgba(0,0,0,.35);
      display:grid; place-items:center; z-index: 9998;
    }
    .appt-dialog{
      width:min(680px, 92vw);
      background: var(--brand, #DD338B);
      color:#fff;
      border-radius:16px;
      box-shadow: 0 24px 60px rgba(0,0,0,.25);
      padding: 18px;
    }
    .appt-dialog__head{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:flex-start; margin-bottom:12px; }
    .appt-dialog__name{ font-weight:700; }
    .appt-dialog__name small{ display:block; font-weight:600; opacity:.9; }
    .appt-dialog__time{
      background:#fff; color:#111; font-weight:700; border-radius:12px;
      padding:8px 10px; border:1px solid rgba(0,0,0,.06);
    }
    .appt-dialog__actions{
  display:grid;
  grid-template-columns: 1fr 1fr; /* <--- CORREGIDO para 2 botones */
  gap:12px;
  margin-top:12px;
}
    .appt-dialog__footer{ display:flex; justify-content:flex-end; margin-top:12px; }
    .appt-close{
      background:#fff; color:#111; border:1px solid rgba(0,0,0,.06);
      border-radius:12px; padding:8px 14px; font-weight:700;
    }

    /* Pega este nuevo estilo al final de la secci√≥n <style> */

/* 4) Estilo para tarjetas canceladas */
.appt.appt--cancelled {
  background: #fee2e2 !important; /* Un rojo muy p√°lido */
  color: #7f1d1d !important;      /* Texto rojo oscuro */
  opacity: .95;
}
.appt.appt--cancelled * {
  color: #7f1d1d !important;
}
.appt.appt--cancelled .appt__time {
  background: #fff !important;
  border: 1px solid #fecaca !important;
}
/* Pega este nuevo estilo al final de la secci√≥n <style> */

/* 5) Estilo para el contenedor de acciones en la tarjeta */
.appt__actions {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(0, 0, 0, 0.08);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Estilo del bot√≥n de recordatorio */
.btn-reminder {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background-color: #e0f2fe; /* Azul cielo p√°lido */
  color: #0c4a6e; /* Azul oscuro */
  border: 1px solid #bae6fd;
  padding: 6px 12px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
}

/* Estilo para la campanita de aviso */
.appt::before {
  content: 'üîî';
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 16px;
  opacity: 0;
  transform: scale(0.5) rotate(20deg);
  transition: all 0.3s ease-in-out;
}

/* Clase que activa la visibilidad de la campanita */
.appt.is-due::before {
  opacity: 1;
  transform: scale(1) rotate(0deg);
  animation: ring-animation 1.5s 2s ease-in-out infinite;
}

/* Animaci√≥n para que la campana llame la atenci√≥n */
@keyframes ring-animation {
  0%, 100% { transform: rotate(0); }
  10% { transform: rotate(15deg); }
  20% { transform: rotate(-10deg); }
  30% { transform: rotate(5deg); }
  40% { transform: rotate(-2deg); }
  50% { transform: rotate(0); }
}


  </style>
</head>
<body>
  <main class="phone">

    <!-- ===== PEGA ESTE C√ìDIGO AQU√ç ===== -->
    <div id="loader" class="loader-container">
      <div class="loader-spinner"></div>
      <p>Cargando...</p>
    </div>
    <!-- ================================ -->

    <div class="page-cover" id="pageCover" aria-hidden="true"></div>

    <img src="./assets/hojas.svg" alt="" aria-hidden="true" class="leaf leaf--tl">


    <div class="page-cover" id="pageCover" aria-hidden="true"></div>

    <img src="./assets/hojas.svg" alt="" aria-hidden="true" class="leaf leaf--tl">
    <img src="./assets.svg" alt="" aria-hidden="true" class="leaf leaf--br">
    <div class="bg-deco bg-deco--tl" aria-hidden="true"></div>
    <div class="bg-deco bg-deco--br" aria-hidden="true"></div>

    <header class="banner" id="banner">
      <div class="banner__row">
        <img id="bizLogo" class="avatar" src="./assets/logo.svg" alt="Logo" />
        <div class="banner__name" id="bizName">Mi negocio</div>
        <button id="menuBtn" class="icon-btn menu-btn" aria-label="Men√∫" aria-haspopup="menu" aria-expanded="false">‚ãÆ</button>
        <nav id="menuPanel" class="menu-panel" hidden role="menu" aria-labelledby="menuBtn">
          <a role="menuitem" href="./agenda.html">Inicio</a>
          <a role="menuitem" href="./realizadas.html">Citas realizadas</a>
          <a role="menuitem" href="./canceladas.html">Citas canceladas</a>
          <a role="menuitem" href="./servicios.html">Servicios</a>
          <a role="menuitem" href="./horarios.html">Horarios y bloqueos</a>
          <a role="menuitem" href="./configuracion.html">Configuraci√≥n</a>
          <button role="menuitem" type="button" class="menu-logout" data-action="logout">Cerrar sesi√≥n</button>
        </nav>
      </div>
    </header>

    <!-- Pega esto justo DESPU√âS de la etiqueta </header> -->
<div id="renewalBanner" style="display: none; background-color: #fffbeb; color: #b45309; padding: 12px 16px; text-align: center; font-size: 14px; font-weight: 500; border-bottom: 1px solid #fde68a;">
  <p style="margin: 0;">‚ö†Ô∏è Tu plan vence el <b id="renewalDate"></b>. <a href="URL_DEL_LINK_DE_PAGO_DE_WOMPI" style="font-weight: 700; text-decoration: underline; color: #b45309; margin-left: 8px;">Renovar Ahora</a></p>
</div>

    <section class="share-row">
      <span class="share-row__label">copiar link de divulgaci√≥n</span>
      <input id="shareInput" class="share-row__input" type="text" readonly>
      <button id="copyBtn" class="btn-chip" type="button">Copiar</button>
    </section>

    <section class="glass calendar">
      <div class="calendar__top">
        <button class="cal-nav" id="prevMonth" aria-label="Mes anterior">‚Äπ</button>
        <div class="calendar__title">
          <span id="monthName">OCT</span>
          <span id="yearNum">2025</span>
        </div>
        <button class="cal-nav" id="nextMonth" aria-label="Mes siguiente">‚Ä∫</button>
      </div>
      <div class="calendar__grid">
        <div class="dow">
          <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
        </div>
        <div id="daysGrid"></div>
      </div>
    </section>

    <section class="appointments">
      <h2 class="appointments__title" id="dayTitle">Citas del d√≠a</h2>
      <div id="apptList" class="appointments__list"></div>
    </section>

    <a href="./reserva.html" class="fab" aria-label="Crear cita">cita</a>
    <div id="toast" class="toast" hidden role="alert" aria-live="assertive"></div>

    <!-- ===== NUEVO MODAL DE PAGO (VERSI√ìN A PRUEBA DE ERRORES) ===== -->
<div id="paymentModalBackdrop" style="display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 2000; display: grid; place-items: center;">
  <div style="background: white; color: #111; border-radius: 16px; padding: 24px; width: min(90vw, 400px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;">
    <h3 style="color: #b91c1c; font-size: 20px; font-weight: 700; margin: 0 0 12px;">Tu plan ha terminado</h3>
    <p style="color: #4b5563; line-height: 1.6; margin: 0 0 24px;">Para reactivar tu agenda y recibir nuevas citas, activa tu plan por <strong>$25.000/mes</strong>.</p>
    <div style="display: flex; flex-direction: column; gap: 12px;">
      <a href="URL_DEL_LINK_DE_PAGO_DE_WOMPI" style="background: var(--brand, #DD338B); color: white; padding: 12px; border-radius: 999px; text-decoration: none; font-weight: 700; border: none;">Activar mi Plan</a>
      <button id="paymentModalClose" style="background: none; color: #6b7280; padding: 10px; border-radius: 999px; font-weight: 600; border: none; cursor: pointer;">M√°s tarde</button>
    </div>
  </div>
</div>
<!-- ================================================================ -->

  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./supabaseClient.js"></script>

<script>
(async () => {
  // ===== Sesi√≥n =====
  const { data: u } = await sb.auth.getUser();
  if (!u?.user) { location.href = 'login.html'; return; }
  const userId = u.user.id;

  

  const daysGrid = document.getElementById('daysGrid');
  const apptList = document.getElementById('apptList');
  const dayTitle = document.getElementById('dayTitle');

  // ===== Helpers =====
  function hexToRgb(hex){ const n=hex.replace('#',''); const big=parseInt(n.length===3?n.split('').map(c=>c+c).join(''):n.slice(0,6),16); return{r:(big>>16)&255,g:(big>>8)&255,b:big&255};}
  function showToast(msg, type='info', ms=2200){ const t=document.getElementById('toast'); if(!t)return; t.textContent=msg; t.className=`toast toast--${type} is-visible`; t.hidden=false; clearTimeout(window._toastTimer); window._toastTimer=setTimeout(()=>{t.classList.remove('is-visible');t.hidden=true;},ms);}

  // Men√∫
  const menuBtn = document.getElementById('menuBtn');
  const menuPanel = document.getElementById('menuPanel');
  function closeMenu(){ if(menuPanel.hidden) return; menuPanel.hidden = true; menuBtn.setAttribute('aria-expanded','false'); }
  menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const open = menuPanel.hidden; menuPanel.hidden = !open; menuBtn.setAttribute('aria-expanded', String(open)); });
  document.addEventListener('click', (e)=>{ if(!menuPanel.hidden && !menuPanel.contains(e.target) && e.target !== menuBtn){ closeMenu(); }});
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeMenu(); });
  menuPanel.addEventListener('click', async (e)=>{ if(e.target?.dataset?.action === 'logout'){ try{ await sb.auth.signOut(); location.href='login.html'; } catch(err){ console.error(err); }}});


  document.getElementById('loader').classList.add('hidden');

  // ===== Negocio / tema =====
  document.querySelector('.fab').href = `./reserva.html?b=${encodeURIComponent(userId)}`;
  const { data: biz, error } = await sb
    .from('businesses')
    .select('*, subscription_status, current_period_ends_at')
    .eq('user_id', userId)
    .order('updated_at', { ascending: false })
    .limit(1)
    .maybeSingle();
  if (error) { console.error(error); return; }
  if (!biz) { location.href = 'personalizacion.html'; return; }


  // ==========================================================
// ===== INICIO: SUPERVISOR DE SUSCRIPCI√ìN =====
// ==========================================================
let isSubscriptionActive = false;
let userAccessStatus = 'LOADING';

const status = biz.subscription_status;
const endDate = new Date(biz.current_period_ends_at);
const now = new Date();

if (status === 'active' || (status === 'trial' && now < endDate)) {
  isSubscriptionActive = true;
  userAccessStatus = 'ACTIVE';
} else {
  isSubscriptionActive = false;
  userAccessStatus = 'EXPIRED';
}

if (isSubscriptionActive) {
    const AVISO_DIAS_ANTES = 1;
    const timeDifference = endDate.getTime() - now.getTime();
    const daysRemaining = timeDifference / (1000 * 3600 * 24);
    if (daysRemaining <= AVISO_DIAS_ANTES && daysRemaining > 0) {
        userAccessStatus = 'RENEWAL_WARNING';
    }
}
// ========================================================
// ===== FIN DEL SUPERVISOR =====
// ========================================================

  const nameEl = document.getElementById('bizName');
  nameEl.textContent = biz.business_name || 'Mi negocio';
  document.title = `${nameEl.textContent} ¬∑ Mi agenda`;
  const root=document.documentElement; const brand=(biz.brand||'#DD338B').toUpperCase();
  const {r,g,b} = hexToRgb(brand);
  root.style.setProperty('--brand',brand);
  root.style.setProperty('--brand-rgb',`${r} ${g} ${b}`);
  root.style.setProperty('--bg',biz.bg_pastel||'#FAE9F2');
  const logoEl=document.getElementById('bizLogo'); logoEl.src=biz.logo_url||'./assets/logo.svg'; logoEl.onerror=()=>{logoEl.src='./assets/logo.svg';};
  const pageCover=document.getElementById('pageCover'); const banner=document.getElementById('banner'); if(biz.cover_url){pageCover.style.backgroundImage=`url('${biz.cover_url}')`; banner.style.setProperty('--cover-url',`url('${biz.cover_url}')`); banner.classList.add('banner--with-cover');}

  const shareInput=document.getElementById('shareInput'); const copyBtn=document.getElementById('copyBtn');
  const base=location.origin+location.pathname.replace(/\/[^/]*$/,'/'); shareInput.value=`${base}reserva.html?b=${encodeURIComponent(userId)}`;
  copyBtn.onclick=async()=>{try{await navigator.clipboard.writeText(shareInput.value);showToast('Link copiado','success',1200);}catch{showToast('No se pudo copiar','error',2200);}};

  // ===== Utilidades de tiempo / dinero =====
  const fmtMoney = n => Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
  const addMinutes = (hhmm, mins) => {
    const [h,m] = (hhmm||'00:00').split(':').map(Number);
    const d = new Date(0,0,0, h||0, m||0, 0);
    d.setMinutes(d.getMinutes() + (mins||0));
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  };
  const to12h = hhmm => {
    const [h,m] = (hhmm||'00:00').split(':').map(Number);
    return new Date(0,0,0,h||0,m||0).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true}).toUpperCase();
  };

  // ¬øYa venci√≥? (usa la fecha del d√≠a mostrado)
  function isExpired(dayISO, endHHMM){
    if(!endHHMM) return false;
    const end = new Date(`${dayISO}T${endHHMM}:00`);
    const now = new Date();
    return end.getTime() <= now.getTime();
  }

  // ===== Cargar citas de un d√≠a =====
  async function loadAppointmentsOfDay(dayISO) {
    apptList.innerHTML = '<div class="card empty">Cargando citas...</div>';

    const { data, error } = await sb
      .from('appointments')
      .select('id, customer_name, service_name, price, time, duration_minutes, notes, whatsapp, status')
      .eq('user_id', userId)
      .eq('date', dayISO)
      .order('time', { ascending: true });

    apptList.innerHTML = '';
    if (error) {
      console.error("Error cargando citas del d√≠a:", error);
      apptList.innerHTML = '<div class="card empty">Error al cargar las citas.</div>';
      return;
    }
    if (!data || !data.length) {
      apptList.innerHTML = '<div class="card empty">No hay citas reservadas para este d√≠a.</div>';
      return;
    }

    // REEMPLAZA TU BUCLE 'for' ACTUAL CON ESTA VERSI√ìN CORREGIDA

for (const a of data) {
    const start = a.time;
    const end = addMinutes(start, (a.duration_minutes ?? 60));
    const timeRange = `${to12h(start)}‚Äì${to12h(end)}`;

    const card = document.createElement('div');
    card.className = 'card appt';
    card.dataset.id = a.id;
    card.dataset.status = a.status || 'confirmed';

    // --- L√ìGICA DE LA CAMPANITA ---
    const appointmentDateTime = new Date(`${dayISO}T${start}`);
    const now = new Date();
    const minutesDifference = (appointmentDateTime.getTime() - now.getTime()) / (1000 * 60);

    let reminderButtonHtml = '';
    // ===== AQU√ç EST√Å LA CORRECCI√ìN CLAVE =====
    // Ahora solo se activa si la cita NO est√° cancelada Y est√° pr√≥xima.
    if (a.status !== 'cancelled' && minutesDifference <= 90 && minutesDifference > 0) {
        card.classList.add('is-due');
        if (a.whatsapp) {
            reminderButtonHtml = `
              <div class="appt__actions">
                <button class="btn-reminder" 
                        data-wa="${a.whatsapp}" 
                        data-name="${a.customer_name}" 
                        data-service="${a.service_name}"
                        data-time="${to12h(start)}">
                  üîî Enviar Recordatorio
                </button>
              </div>
            `;
        }
    }
    // --- FIN DE LA L√ìGICA ---

    if (isExpired(dayISO, end)) {
        card.classList.add('appt--expired');
    }
    if (a.status === 'cancelled') {
        card.classList.add('appt--cancelled');
    }

    card.innerHTML = `
      <div>
        <div class="appt__name">${a.customer_name || ''}</div>
        <div class="appt__meta">
          <span>${a.service_name || ''}</span>
          <span class="appt__price">${fmtMoney(a.price)}</span>
        </div>
      </div>
      <div class="appt__time">${timeRange}</div>
      ${a.notes ? `<div class="appt__note">${a.notes}</div>` : ''}
      ${reminderButtonHtml} 
    `;

    card.addEventListener('click', (e) => {
        if (e.target.closest('.btn-reminder')) return;
        
        const currentStatus = card.dataset.status || a.status || 'confirmed';
        // CORRECCI√ìN IMPORTANTE: Aseg√∫rate de pasar 'date' a la funci√≥n del modal
        const dateForModal = a.date || dayISO;
        openApptDialog({ ...a, date: dateForModal, status: currentStatus }, timeRange, card);
    });

    apptList.appendChild(card);
}
  }

  // ===== Panel flotante =====
  function openApptDialog(appt, timeRange, cardEl){
    const backdrop = document.createElement('div');
    backdrop.className = 'appt-backdrop';
    const dialog = document.createElement('div');
    dialog.className = 'appt-dialog';

    const money = fmtMoney(appt.price);
    const whatsappHtml = appt.whatsapp ? `<div class="appt-field">whatsapp: ${appt.whatsapp}</div>` : '';
    const notesHtml = appt.notes ? `<div class="appt-field appt-note">${appt.notes}</div>` : '';

    dialog.innerHTML = `
      <div class="appt-dialog__head">
        <div class="appt-dialog__name">
          ${appt.customer_name || ''}<br>
          <small>${appt.service_name || ''}</small>
        </div>
        <div class="appt-dialog__time">${timeRange}</div>
      </div>

      <div class="appt-dialog__body">
        <div class="appt-chip">${money}</div>
        ${whatsappHtml}
        ${notesHtml}
      </div>

      <div class="appt-dialog__actions">
        
        <button class="btn-status btn-done" data-status="done">realizada</button>
        <button class="btn-status btn-cancelled" data-status="cancelled">cancelada</button>
      </div>

      <div class="appt-dialog__footer">
        <button class="appt-close">Cerrar</button>
      </div>
    `;

    // resaltar el estado real guardado
    const setActive = (s)=>{
      dialog.querySelectorAll('.btn-status').forEach(b=>{
        b.classList.toggle('is-active', b.dataset.status === s);
      });
    };
    setActive(appt.status || 'confirmed');

    // Cambiar estado en Supabase
    // C√ìDIGO NUEVO (PEGA TODO ESTE BLOQUE EN LUGAR DEL ANTERIOR):
dialog.querySelectorAll('.btn-status').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const newStatus = btn.dataset.status;

    // --- INICIO DE LA NUEVA L√ìGICA DE CANCELACI√ìN (Regla de 2 horas) ---
    if (newStatus === 'cancelled') {
      const MIN_HOURS_BEFORE_CANCELLATION = 2; // Tu regla de 2 horas

      const appointmentDateTime = new Date(`${appt.date}T${appt.time}`);
      const now = new Date();
      const hoursDifference = (appointmentDateTime.getTime() - now.getTime()) / (1000 * 60 * 60);

      // Si la cita ya pas√≥ o es en menos de 2 horas, mostramos una advertencia.
      if (hoursDifference < MIN_HOURS_BEFORE_CANCELLATION) {
        // La cita ya pas√≥, no tiene sentido advertir, solo cancelar.
        if (hoursDifference < 0) {
            // No hacemos nada especial, simplemente dejamos que se cancele.
        } else {
            // La cita es pronto, advertimos al due√±o.
            const confirmLateCancellation = confirm(
              "ADVERTENCIA: Faltan menos de 2 horas para esta cita.\n\n" +
              "Si contin√∫as, la cita se marcar√° como cancelada y el horario se liberar√° para otros clientes.\n\n" +
              "¬øEst√°s seguro de que quieres cancelarla?"
            );
            // Si el due√±o presiona "Cancelar" en el aviso, detenemos todo.
            if (!confirmLateCancellation) {
              return; 
            }
        }
      }
    }
    // --- FIN DE LA NUEVA L√ìGICA ---

    // El resto del c√≥digo es el que ya ten√≠as para actualizar el estado
    if (newStatus === (appt.status || 'confirmed')) {
      setActive(newStatus);
      return;
    }
    setActive(newStatus); // optimista
    try {
  const { error } = await sb
    .from('appointments')
    .update({ status: newStatus })
    .eq('id', appt.id)
    .eq('user_id', userId);
  if (error) throw error;
  
  appt.status = newStatus;
  if (cardEl) {
    cardEl.dataset.status = newStatus;
    // ===== A√ëADE ESTA L√ìGICA DE CLASES =====
    if (newStatus === 'cancelled') {
      cardEl.classList.add('appt--cancelled');
    } else {
      cardEl.classList.remove('appt--cancelled');
    }
    // ========================================
  }
  showToast('Estado actualizado', 'success', 1200);
    }catch(err){
      console.error(err);
      setActive(appt.status || 'confirmed'); // revertir si falla
      showToast('No se pudo actualizar', 'error', 1800);
    }
  });
});

    // Cerrar
    dialog.querySelector('.appt-close').addEventListener('click', ()=> document.body.removeChild(backdrop));
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) document.body.removeChild(backdrop); });

    backdrop.appendChild(dialog);
    document.body.appendChild(backdrop);
  }

  // ===== Calendario =====
  const monthName = document.getElementById('monthName');
  const yearNum = document.getElementById('yearNum');
  const MONTHS = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];

  const todayObj = new Date();
  const todayStr = `${todayObj.getFullYear()}-${String(todayObj.getMonth()+1).padStart(2,'0')}-${String(todayObj.getDate()).padStart(2,'0')}`;

  let current = new Date(todayObj.getFullYear(), todayObj.getMonth(), 1);

  function renderMonth(d) {
    monthName.textContent = MONTHS[d.getMonth()];
    yearNum.textContent = d.getFullYear();
    daysGrid.innerHTML = '';

    const firstDow = (new Date(d.getFullYear(), d.getMonth(), 1).getDay() + 6) % 7;
    const lastDate = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();

    for (let i = 0; i < firstDow; i++) {
      const e = document.createElement('div'); e.className = 'day is-empty'; daysGrid.appendChild(e);
    }

    for (let day = 1; day <= lastDate; day++) {
      const e = document.createElement('div');
      e.className = 'day';
      e.textContent = day;

      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const dayStr = `${y}-${m}-${String(day).padStart(2, '0')}`;
      e.dataset.date = dayStr;

      if (dayStr < todayStr) e.classList.add('is-past');
      if (dayStr === todayStr) e.classList.add('is-today');

      daysGrid.appendChild(e);
    }
  }

  async function markMonthAppointments(year, month) {
    const monthStart = `${year}-${String(month + 1).padStart(2, '0')}-01`;
    const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
    const monthEnd = `${year}-${String(month + 1).padStart(2, '0')}-${String(lastDayOfMonth).padStart(2, '0')}`;

    const { data: appointments, error } = await sb
      .from('appointments')
      .select('date')
      .eq('user_id', userId)
      .gte('date', monthStart)
      .lte('date', monthEnd);

    if (error) { console.error("Error al obtener las citas del mes:", error); return; }

    const daysWithAppointments = new Set((appointments || []).map(a => a.date));

    daysGrid.querySelectorAll('.day').forEach(el => {
      const dayStr = el.dataset.date;
      el.classList.remove('has-appt-future', 'has-appt-past');

      if (daysWithAppointments.has(dayStr)) {
        if (dayStr < todayStr) {
          el.classList.add('has-appt-past');    // puntico (pasado con cita)
        } else {
          el.classList.add('has-appt-future');  // casilla llena (hoy/futuro con cita)
        }
      }
    });
  }

  // Navegaci√≥n
  document.getElementById('prevMonth').onclick = async () => {
    current = new Date(current.getFullYear(), current.getMonth() - 1, 1);
    renderMonth(current);
    await markMonthAppointments(current.getFullYear(), current.getMonth());
  };
  document.getElementById('nextMonth').onclick = async () => {
    current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
    renderMonth(current);
    await markMonthAppointments(current.getFullYear(), current.getMonth());
  };

  // Click d√≠a (YA permite pasados)
  daysGrid.addEventListener('click', async (e) => {
    const box = e.target.closest('.day');
    if (!box || box.classList.contains('is-empty')) return;

    daysGrid.querySelectorAll('.day.is-selected').forEach(d => d.classList.remove('is-selected'));
    box.classList.add('is-selected');

    const dateStr = box.dataset.date;
    const d = new Date(`${dateStr}T00:00:00`);
    const fmt = d.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
    dayTitle.textContent = `Citas del ${fmt}`;
    await loadAppointmentsOfDay(dateStr);
  });

  // PEGA ESTE NUEVO BLOQUE EN SU LUGAR:

// ===== Carga inicial (Versi√≥n Progresiva) =====
// 1. Dibuja la estructura del calendario INMEDIATAMENTE.
renderMonth(current);

// 2. Selecciona el d√≠a de hoy en el calendario.
const todayElement = daysGrid.querySelector(`[data-date="${todayStr}"]`);
if (todayElement) {
  todayElement.classList.add('is-selected');
  dayTitle.textContent = `Citas de hoy (${todayObj.toLocaleDateString('es-ES', {day:'numeric', month:'long'})})`;
}

// 3. Ahora, pide los datos "pesados" (citas del mes y del d√≠a)
//    y deja que se carguen en segundo plano sin bloquear la p√°gina.
Promise.all([
    markMonthAppointments(current.getFullYear(), current.getMonth()),
    loadAppointmentsOfDay(todayStr)
]);
 

  // PEGA ESTE BLOQUE JUSTO ANTES DE LA L√çNEA FINAL '})();'

// ===== L√≥gica para el Bot√≥n de Recordatorio de WhatsApp =====
apptList.addEventListener('click', (e) => {
    const reminderButton = e.target.closest('.btn-reminder');
    
    // Si no se hizo clic en un bot√≥n de recordatorio, no hacemos nada
    if (!reminderButton) return;

    const clientName = reminderButton.dataset.name;
    const clientWa = reminderButton.dataset.wa;
    const serviceName = reminderButton.dataset.service;
    const time12h = reminderButton.dataset.time;
    const businessName = nameEl.textContent; // Usamos el nombre del negocio ya cargado

    // Mensaje de recordatorio (¬°puedes personalizarlo!)
    const message = `¬°Hola ${clientName}! üëã Te recordamos tu cita en *${businessName}* para un servicio de *${serviceName}* hoy a las *${time12h}*. ¬°Te esperamos! üòä`;

    // Creamos el enlace de WhatsApp
    // Aseg√∫rate de que el n√∫mero no incluya '+' o espacios. Si es necesario, a√±ade el c√≥digo de pa√≠s.
    const whatsappUrl = `https://wa.me/57${clientWa}?text=${encodeURIComponent(message)}`;

    // Abrimos la URL en una nueva pesta√±a
    window.open(whatsappUrl, '_blank');
});


// =================================================================
// ===== L√ìGICA DE ACCI√ìN DE SUSCRIPCI√ìN Y FUNCIONES DE AYUDA =====
// =================================================================
// REEMPL√ÅZALA CON ESTA VERSI√ìN:
function showPaymentModal() {
  const modal = document.getElementById('paymentModalBackdrop');
  if (modal) modal.style.display = 'grid'; // <-- ¬°CORREGIDO!
}

function handleSubscriptionLock() {
  const fabButton = document.querySelector('.fab');
  if (fabButton) {
    fabButton.addEventListener('click', (e) => {
      e.preventDefault();
      showPaymentModal();
    });
  }
  const copyBtn = document.getElementById('copyBtn');
  if(copyBtn) {
    copyBtn.disabled = true;
    copyBtn.style.cursor = 'not-allowed';
    copyBtn.style.opacity = '0.5';
  }
}

function showRenewalBanner() {
  const banner = document.getElementById('renewalBanner');
  const dateEl = document.getElementById('renewalDate');
  if (banner && dateEl) {
    dateEl.textContent = new Date(biz.current_period_ends_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
    banner.style.display = 'block';
  }
}

// ACTUAMOS SEG√öN EL ESTADO CALCULADO POR EL SUPERVISOR
switch (userAccessStatus) {
  case 'RENEWAL_WARNING':
    showRenewalBanner();
    break;
  case 'EXPIRED':
    handleSubscriptionLock();
    showPaymentModal();
    break;
}

// Evento para el bot√≥n de cerrar del modal de pago
const paymentModalCloseBtn = document.getElementById('paymentModalClose');
if (paymentModalCloseBtn) {
  paymentModalCloseBtn.addEventListener('click', () => {
    document.getElementById('paymentModalBackdrop').style.display = 'none';
  });
}
// ===============================================================
// ===== FIN DE LA L√ìGICA DE ACCI√ìN =====
// ===============================================================

})();
</script>
</body>
</html>